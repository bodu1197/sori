#!/bin/sh
# =============================================================================
# VibeStation - Pre-Commit Hook (MAXIMUM STRICTNESS)
# 최고 엄격 품질 검증 - SonarQube + ESLint + TypeScript
# =============================================================================

echo ""
echo "╔════════════════════════════════════════════════════════════╗"
echo "║    VibeStation Quality Gate - PRE-COMMIT (STRICT MODE)    ║"
echo "╠════════════════════════════════════════════════════════════╣"
echo "║  ⚠️  All checks MUST pass before commit is allowed        ║"
echo "╚════════════════════════════════════════════════════════════╝"
echo ""

cd frontend

# =============================================================================
# Step 1: TypeScript Strict Check
# =============================================================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "[1/4] TypeScript Strict Type Check..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
npx tsc --noEmit --strict
if [ $? -ne 0 ]; then
    echo ""
    echo "❌ BLOCKED: TypeScript errors detected!"
    echo "   Fix all type errors before committing."
    exit 1
fi
echo "✅ TypeScript: PASSED"
echo ""

# =============================================================================
# Step 2: ESLint with Zero Tolerance
# =============================================================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "[2/4] ESLint Zero-Error Check..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
npx lint-staged --no-stash
if [ $? -ne 0 ]; then
    echo ""
    echo "❌ BLOCKED: ESLint errors detected!"
    echo "   Fix all lint errors before committing."
    exit 1
fi
echo "✅ ESLint: PASSED"
echo ""

# =============================================================================
# Step 3: Prettier Format Check
# =============================================================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "[3/4] Prettier Format Verification..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css}" 2>/dev/null
if [ $? -ne 0 ]; then
    echo ""
    echo "❌ BLOCKED: Formatting issues detected!"
    echo "   Run 'npm run format' to fix formatting."
    exit 1
fi
echo "✅ Prettier: PASSED"
echo ""

# =============================================================================
# Step 4: Security Vulnerability Check
# =============================================================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "[4/4] Security Vulnerability Check..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
npm audit --audit-level=high 2>/dev/null
AUDIT_EXIT=$?
if [ $AUDIT_EXIT -gt 0 ]; then
    echo ""
    echo "⚠️  WARNING: High/Critical vulnerabilities found!"
    echo "   Consider running 'npm audit fix' to resolve."
fi
echo "✅ Security Check: COMPLETED"
echo ""

echo "╔════════════════════════════════════════════════════════════╗"
echo "║    ✅ PRE-COMMIT: ALL CHECKS PASSED                       ║"
echo "╚════════════════════════════════════════════════════════════╝"
echo ""
